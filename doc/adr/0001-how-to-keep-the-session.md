# セッションをどのように持つか

## Context

`JWT` と `Cookie` どちらを使うか決めかねている。

## Opinions

JWTの検証はJWKをキャッシュしておけばリクエストごとに鍵をfetchする必要はない。普通はそのように実装する。=> JWT検証の負荷は無視できる。Cookieのdecryptと同じだろう。  
JWTの検証をパスした後で、そのuidのユーザーがDBに存在するかどうかチェックする必要があるのでDBアクセスが生じる(それってCookieの場合でも同じことか？) それがユーザーのデータに触る必要がないケースであっても。しかし、APIを叩く場面でDBにアクセスしない用途って何だろう？そのような場合に認証済みかどうかをチェックする場合にオーバーヘッドになる。Cookieの場合、DBへのアクセスが生じないか？ユーザーが削除されるパターンもあるので結局、毎回ユーザーのチェックはした方がよい気がするな。ユーザーの認証/認可をする際にはDBへのアクセスはいずれの場合でも生じるだろう。  
Cookieの問題はFirebaseでのログイン状態とCookieでのログイン状態の二重管理になること。

## Pros/Cons

JWT
- JWTのみではユーザー作成済みか不明なので常にDBアクセスを伴う
- セッションの無効化ができない
  - 時間経過でid tokenは無効になる(1h)

Cookie
- セッションの二重管理
- セッションの無効化ができない
  - flagを用意する必要あり

## Decision

JWT  
セッションの二重管理をやりたくない

## Reference

id tokenの有効期間  
https://firebase.google.com/docs/auth/admin/manage-sessions?hl=ja
